import telebot
import pyfirmata
from pyfirmata import util
import time

Controler = pyfirmata.ArduinoMega('COM4')
PassCode = 'hello'
Token = '5401128449:AAHQhtCWe10yG6KIcA2fjrvSRF8ZvErSmAI'
Home = telebot.TeleBot(Token)

#Pinlerin Teyini
DoorPin = Controler.digital[10]
LightsPin = Controler.digital[13]
GasSensPin = Controler.analog[0]

@Home.message_handler(commands=['LightsOn'])
def LightsOn(message):
    LightsPin.write(1)
    print('Isiq yandi!')

@Home.message_handler(commands=['LightsOff'])
def LightsOff(message):
    LightsPin.write(0)
    print('Isiqlar sondu!')

@Home.message_handler(commands=['GasRead'])
def GasRead(message):
    print('Qaz sensoru oxundu!')
    reader = pyfirmata.util.Iterator(Controler)
    reader.start()
    sensor = GasSensPin
    sensor.enable_reporting()
    while True:
        data = str(sensor.read())
        if data != 'None':
            print(sensor.read())
            Home.reply_to(message,"Havadaki qaz miqdarı: {}".format(data))
            print('Melumat gonderildi!')
            break

@Home.message_handler(commands=['clear'])
def StartCommand(message):
    Hosts = open('F:\MyHome\Hosts.txt', 'w')

@Home.message_handler(commands=['start'])
def StartCommand(message):
    Home.reply_to(message, 'Ev sahibləri üçün giriş:\n /MyHome\nYeni gələnlər üçün giriş:\n /Register')


@Home.message_handler(commands=['Register'])
def StartCommand(messaj):
    Home.reply_to(messaj, 'Evinizə xoş gəldiniz! Parolu daxil edin.')

    @Home.message_handler(func=lambda messaj: True)
    def IDCheck(messaj):
        UserInput = messaj.text
        UserID = messaj.chat.id
        print(UserInput)
        print(UserID)


        if str(UserInput).lower() == str(PassCode):
            Hosts = open('F:\MyHome\Hosts.txt', 'a')
            Hosts.writelines(str(UserID))
            Hosts.writelines(' ')

            HostList = []
            Hosts = open('F:\MyHome\Hosts.txt', 'r')
            HostList.append(Hosts.read())
            print(HostList)
            for i in HostList:
                HostList2 = HostList[0].split(' ')
                print(HostList2)
                if str(UserID) in HostList2:
                    print('Yeni sahibin qeydiyyati tamamlandi!')
                    Home.reply_to(messaj,
                                  "Ev sahibinin tanınması başa çatdı! \n Əmrlər menüsu: \n /Info \n /UserGuide \n /LightsOn \n /LightsOff \n /OpenDoor \n /CloseDoor \n /GasRead \n /DoorCheck  \n /WindowCheck")
                else:
                    print('New user!')
                    Home.reply_to(messaj, 'You are a new user!')
        elif str(UserInput) != str(PassCode):
            print("Uğursuz giriş cəhdi!")
            Home.reply_to(messaj, 'Şifrənizi daxil edin.')



@Home.message_handler(commands=['MyHome'])
def StartCommand(message):
    Home.reply_to(message, 'Evinizə xoş gəldiniz! Adinizi daxil edin.')

    @Home.message_handler(func=lambda m: True)
    def IDCheck(message):
        UserInput = message.text
        UserID = message.chat.id
        print(UserInput)
        print(UserID)

        HostList = []
        Hosts = open('F:\MyHome\Hosts.txt', 'r')
        HostList.append(Hosts.read())
        print(HostList)
        for i in HostList:
            HostList2 = HostList[0].split(' ')
            print(HostList2)
            if str(UserID) in HostList2:
                print('Yeni sahibin taninmasi basa catdi!')
                Home.reply_to(message,
                              "Ev sahibinin tanınması başa çatdı! \n Əmrlər menüsu: \n /Info \n /UserGuide \n /LightsOn \n /LightsOff \n /OpenDoor \n /CloseDoor \n /GasRead \n /DoorCheck  \n /WindowCheck")
            elif str(UserID) not in HostList2:
                Home.reply_to(message,
                              'Siz ev sahibi deyilsiniz! \nQeydiyyatdan keçmək üçün /register əmrindən istifadə edin.')


while True:
    Home.polling()
